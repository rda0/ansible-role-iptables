#!/bin/bash

##### iptables rules configuration file #####


## General options

# Script options
PATH=/sbin:/usr/sbin:/bin:/usr/bin

# Debugging (verbosity: 0=off, 1=debug, 2=debugrules)
DEBUG="{{ iptables_debug|default(0) }}"

# Logging of DROP/REJECT (verbosity: 0=off, 1=out-only, 2=out/fw, 3=in/out/fw, 4=all (incl. casts
LOG_LEVEL="{{ iptables_log_level|default(2) }}"

# Logging options (`--log-prefix` always required as last option)
LOG_OPTS="--log-level 7 --log-ip-options --log-uid --log-prefix"

# Interfaces
if_ext="{{ iptables_if_ext | default(ansible_default_ipv4.interface) }}"
if_br_ext="{{ iptables_if_br_ext | default() }}"
if_br="{{ iptables_if_br | default() }}"
if_int=""

# Network list (do not include special networks `prv`, `prvcan`, `any`)
nets="adm san cun srv lan can"
# Network address hashtable
declare -A net
# Allowed ports hashtable
declare -A port
# NAT hashtable
declare -A nat
# Rate limit hashtable
declare -A lim
# Logging limit hashtable
declare -A log

# Log levels defaults
log_lvl_output="{{ iptables_log_lvl_output|default(0) }}"
log_lvl_forward="{{ iptables_log_lvl_forward|default(1) }}"
log_lvl_input="{{ iptables_log_lvl_input|default(2) }}"
log_lvl_special="{{ iptables_log_lvl_special|default(3) }}"

# Log levels (logged when: main log_level > individual level defined here)
log[o_deny_lvl]="{{ iptables_log_o_deny_lvl|default('${log_lvl_output}') }}"
log[f_deny_lvl]="{{ iptables_log_f_deny_lvl|default('${log_lvl_forward}') }}"
log[i_deny_lvl]="{{ iptables_log_i_deny_lvl|default('${log_lvl_input}') }}"
log[o_invalid_lvl]="{{ iptables_log_o_invalid_lvl|default('${log_lvl_output}') }}"
log[f_invalid_lvl]="{{ iptables_log_f_invalid_lvl|default('${log_lvl_forward}') }}"
log[i_invalid_lvl]="{{ iptables_log_i_invalid_lvl|default('${log_lvl_input}') }}"
log[i_lim_ssh_can_lvl]="{{ iptables_log_i_lim_ssh_can_lvl|default('${log_lvl_special}') }}"
log[i_lim_ssh_any_lvl]="{{ iptables_log_i_lim_ssh_any_lvl|default('${log_lvl_special}') }}"
log[f_any_s_prv_lvl]="{{ iptables_log_f_any_s_prv_lvl|default('${log_lvl_forward}') }}"
log[i_any_s_prv_lvl]="{{ iptables_log_i_any_s_prv_lvl|default('${log_lvl_input}') }}"
log[i_bcast_lvl]="{{ iptables_log_i_bcast_lvl|default('${log_lvl_special}') }}"
log[i_mcast_lvl]="{{ iptables_log_i_mcast_lvl|default('${log_lvl_special}') }}"
log[i_acast_lvl]="{{ iptables_log_i_acast_lvl|default('${log_lvl_special}') }}"

# Limit rules defaults
log_limit="{{ iptables_log_limit|default('1/s') }}"
log_burst="{{ iptables_log_burst|default('100') }}"

# Logging limits
log[o_deny_limit]="{{ iptables_log_o_deny_limit|default('${log_limit}') }}"
log[o_deny_burst]="{{ iptables_log_o_deny_burst|default('${log_burst}') }}"
log[f_deny_limit]="{{ iptables_log_f_deny_limit|default('${log_limit}') }}"
log[f_deny_burst]="{{ iptables_log_f_deny_burst|default('${log_burst}') }}"
log[i_deny_limit]="{{ iptables_log_i_deny_limit|default('${log_limit}') }}"
log[i_deny_burst]="{{ iptables_log_i_deny_burst|default('${log_burst}') }}"
log[o_invalid_limit]="{{ iptables_log_o_invalid_limit|default('${log_limit}') }}"
log[o_invalid_burst]="{{ iptables_log_o_invalid_burst|default('${log_burst}') }}"
log[f_invalid_limit]="{{ iptables_log_f_invalid_limit|default('${log_limit}') }}"
log[f_invalid_burst]="{{ iptables_log_f_invalid_burst|default('${log_burst}') }}"
log[i_invalid_limit]="{{ iptables_log_i_invalid_limit|default('${log_limit}') }}"
log[i_invalid_burst]="{{ iptables_log_i_invalid_burst|default('${log_burst}') }}"
log[i_lim_ssh_limit]="{{ iptables_log_i_lim_ssh_limit|default('${log_limit}') }}"
log[i_lim_ssh_burst]="{{ iptables_log_i_lim_ssh_burst|default('${log_burst}') }}"
log[i_ban_ssh_limit]="{{ iptables_log_i_ban_ssh_limit|default('${log_limit}') }}"
log[i_ban_ssh_burst]="{{ iptables_log_i_ban_ssh_burst|default('${log_burst}') }}"
log[f_any_s_prv_limit]="{{ iptables_log_f_any_s_prv_limit|default('${log_limit}') }}"
log[f_any_s_prv_burst]="{{ iptables_log_f_any_s_prv_burst|default('${log_burst}') }}"
log[i_any_s_prv_limit]="{{ iptables_log_i_any_s_prv_limit|default('${log_limit}') }}"
log[i_any_s_prv_burst]="{{ iptables_log_i_any_s_prv_burst|default('${log_burst}') }}"
log[i_bcast_limit]="{{ iptables_log_i_bcast_limit|default('${log_limit}') }}"
log[i_bcast_burst]="{{ iptables_log_i_bcast_burst|default('${log_burst}') }}"
log[i_mcast_limit]="{{ iptables_log_i_mcast_limit|default('${log_limit}') }}"
log[i_mcast_burst]="{{ iptables_log_i_mcast_burst|default('${log_burst}') }}"
log[i_acast_limit]="{{ iptables_log_i_acast_limit|default('${log_limit}') }}"
log[i_acast_burst]="{{ iptables_log_i_acast_burst|default('${log_burst}') }}"

# Enable unidirectional stateful filtering, allows all outbound (true/false)
{% if iptables_allow_o_any|default(false) %}
allow_o_any="true"
{% else %}
allow_o_any="false"
{% endif %}

# Enable IP spoofing protection for private address ranges
{% if iptables_deny_i_prv|default(true) %}
deny_i_prv="true"
{% else %}
deny_i_prv="false"
{% endif %}

# Enable deny target DROP, default is: REJECT (true/false)
{% if iptables_deny_target_drop|default(false) %}
deny_target_drop="true"
{% else %}
deny_target_drop="false"
{% endif %}

# Enable rate limits, default is: enabled (1/"")
lim[on]="{{ iptables_lim_on|default(1) }}"
lim[ports]="{{ iptables_lim_ports|default('ssh') }}"
lim[nets]="{{ iptables_lim_nets|default('can any') }}"
lim[ssh_can_on]="{{ iptables_lim_ssh_can_on|default(1) }}"
lim[ssh_any_on]="{{ iptables_lim_ssh_any_on|default(1) }}"
lim[ssh_can_secs]="{{ iptables_lim_ssh_can_secs|default(60) }}"
lim[ssh_can_hits]="{{ iptables_lim_ssh_can_hits|default(20) }}"
lim[ssh_can_time]="{{ iptables_lim_ssh_can_time|default(600) }}"
lim[ssh_any_secs]="{{ iptables_lim_ssh_any_secs|default(120) }}"
lim[ssh_any_hits]="{{ iptables_lim_ssh_any_hits|default(5) }}"
lim[ssh_any_time]="{{ iptables_lim_ssh_any_time|default(3600) }}"


### Networks (in CIDR notation)

## Admin network: adm
# Static variables
net4_adm_0="192.33.96.2/32"         # rda.ethz.ch        (rda)
net4_adm_1="192.33.96.20/32"        # mothership.ethz.ch (daduke)
net4_adm_2="192.33.96.33/32"        # kedavra.ethz.ch    (sasquatch)
net4_adm_3="192.33.96.71/32"        # dumbledore.ethz.ch (chris-tux)
net4_adm_4="192.33.99.100/32"       # inferius.ethz.ch   (ataraxia)
net4_adm_5="192.33.98.60/32"        # reparo.ethz.ch     (shamu)
net4_adm_6="192.33.97.122/32"       # portus.ethz.ch     (globi)
net4_adm_7="192.33.96.147/32"       # methyer.ethz.ch    (tarzeau)
net4_adm_8="192.33.96.34/32"        # ash.ethz.ch        (amartako)
net4_adm_9=""                       #
net4_adm_10="129.132.89.142/32"     # griphook.ethz.ch   (jumphost)
net4_adm_11="129.132.89.144/32"     # hirzli.ethz.ch     (jumphost)
net4_adm_12="" #"129.132.86.215/32" # phd-webxen.ethz.ch
net4_adm_13="" #"129.132.86.214/32" # phd-systemxen.ethz.ch
net4_adm_14="" #"129.132.53.172/32" # silberspitz.ethz.ch
net4_adm_15="" #"129.132.80.42/32"  # silberspitz-hpx137.ethz.ch
# Ansible variables
net4_adm_default="{{ iptables_net4_adm_default | default('${net4_adm_0} ${net4_adm_1} ${net4_adm_2} ${net4_adm_3} ${net4_adm_4} ${net4_adm_5} ${net4_adm_6} ${net4_adm_7} ${net4_adm_8} ${net4_adm_9} ${net4_adm_10} ${net4_adm_11} ${net4_adm_12} ${net4_adm_13} ${net4_adm_14} ${net4_adm_15}') }}"
net6_adm_default="{{ iptables_net6_adm_default | default() }}"
net4_adm_custom="{{ iptables_net4_adm_custom | default() }}"
net6_adm_custom="{{ iptables_net6_adm_custom | default() }}"
# Script variables
net[adm4]="${net4_adm_default} ${net4_adm_custom}"
net[adm6]="${net6_adm_default} ${net6_adm_custom}"

## Private networks (not routed in internet): prv, prvcan
# Private IPv4 address spaces (RFC 1918)
net[prv4]="10.0.0.0/8 172.16.0.0/12 192.168.0.0/16"
# Unique local IPv6 address spaces (RFC 4193)
net[prv6]="fc00::/7"
# Static variables
net4_prvcan_eth="172.30.0.0/16 172.31.0.0/16 10.2.0.0/19 10.2.32.0/19 10.2.64.0/20 10.2.80.0/20 10.2.96.0/20 10.2.112.0/20 10.2.128.0/20 10.2.144.0/20 10.2.160.0/20 10.2.176.0/20 10.2.192.0/20 10.5.0.0/16 10.6.0.0/16 10.4.0.0/16"
net6_prvcan_eth=""
# Ansible variables
net4_prvcan_default="{{ iptables_net4_prvcan_default | default('${net4_prvcan_eth}') }}"
net6_prvcan_default="{{ iptables_net6_prvcan_default | default('${net6_prvcan_eth}') }}"
net4_prvcan_custom="{{ iptables_net4_prvcan_custom | default() }}"
net6_prvcan_custom="{{ iptables_net6_prvcan_custom | default() }}"
# Script variables
net[prvcan4]="${net4_prvcan_default} ${net4_prvcan_custom}"
net[prvcan6]="${net6_prvcan_default} ${net6_prvcan_custom}"

## System/storage area network: san
# Static variables
# Ansible variables
net4_san_default="{{ iptables_net4_san_default | default('') }}"
net6_san_default="{{ iptables_net6_san_default | default('') }}"
net4_san_custom="{{ iptables_net4_san_custom | default() }}"
net6_san_custom="{{ iptables_net6_san_custom | default() }}"
# Script variables
net[san4]="${net4_san_default} ${net4_san_custom}"
net[san6]="${net6_san_default} ${net6_san_custom}"

## Server network: srv
# Static variables
net4_srv_phys_server="129.132.86.192/27"               # server1
net4_srv_phys_dc_server_1="129.132.80.0/26"            # server2
net4_srv_phys_dc_server_2="" #"172.31.108.0/24"        # server2 internal
net4_srv_phys_dc_spec_4="" #"172.31.34.32/27"          # backup iscsi
net4_srv_phys_dc_dock_1="129.132.89.128/25"            # client/server in server room only
net4_srv_lab="129.132.127.64/26"                       # server in lab (testing)
net4_srv_phys_dc_spec_3_1="129.132.53.160/28"          # dual-stack server room
net6_srv_phys_dc_server_1="2001:67c:10ec:3dc4::/118"   # server ipv6
net6_srv_phys_dc_dock_1="2001:67c:10ec:3dc2::/118"     # docking ipv6 server room only
# Ansible variables
net4_srv_default="{{ iptables_net4_srv_default | default('${net4_srv_phys_server} ${net4_srv_phys_dc_server_1} ${net4_srv_phys_dc_server_2} ${net4_srv_phys_dc_spec_4} ${net4_srv_phys_dc_dock_1} ${net4_srv_lab} ${net4_srv_phys_dc_spec_3_1}') }}"
net6_srv_default="{{ iptables_net6_srv_default | default('${net6_srv_phys_dc_server_1} ${net6_srv_phys_dc_dock_1}') }}"
net4_srv_custom="{{ iptables_net4_srv_custom | default() }}"
net6_srv_custom="{{ iptables_net6_srv_custom | default() }}"
# Script variables
net[srv4]="${net4_srv_default} ${net4_srv_custom}"
net[srv6]="${net6_srv_default} ${net6_srv_custom}"

## Local area network: lan
# Static variables
# Ansible variables
net4_lan_default="{{ iptables_net4_lan_default | default('') }}"
net6_lan_default="{{ iptables_net6_lan_default | default('') }}"
net4_lan_custom="{{ iptables_net4_lan_custom | default() }}"
net6_lan_custom="{{ iptables_net6_lan_custom | default() }}"
# Script variables
net[lan4]="${net4_lan_default} ${net4_lan_custom}"
net[lan6]="${net6_lan_default} ${net6_lan_custom}"

## Campus/corporate area network: can
# Static variables
net4_can_eth="82.130.64.0/18 129.132.0.0/16 195.176.96.0/19 148.187.192.0/19 192.33.87.0/24 192.33.88.0/23 192.33.91.0/24 192.33.92.0/24 192.33.93.0/24 192.33.94.0/23 192.33.96.0/21 192.33.104.0/22 192.33.108.0/23 192.33.110.0/24"
net6_can_eth="2001:67c:10ec::/48"
# Ansible variables
net4_can_default="{{ iptables_net4_can_default | default('${net4_can_eth} ${net4_prvcan}') }}"
net6_can_default="{{ iptables_net6_can_default | default('${net6_can_eth} ${net6_prvcan}') }}"
net4_can_custom="{{ iptables_net4_can_custom | default() }}"
net6_can_custom="{{ iptables_net6_can_custom | default() }}"
# Script variables
net[can4]="${net4_can_default} ${net4_can_custom}"
net[can6]="${net6_can_default} ${net6_can_custom}"

## Custom networks (for host specific rules): cun
# Script variables
net[cun4]="{{ iptables_net4_cun_custom | default() }}"
net[cun6]="{{ iptables_net6_cun_custom | default() }}"


#### Open Ports

### Network adm (admins)
## Inbound
# ssh
port[i_tcp_adm]="{{ iptables_i_tcp_adm | default('22') }}"
# mosh
port[i_udp_adm]="{{ iptables_i_udp_adm | default('60000:61000') }}"
## Outbound
# ssh
port[o_tcp_adm]="{{ iptables_o_tcp_adm | default('22') }}"
# 
port[o_udp_adm]="{{ iptables_o_udp_adm | default() }}"
## Forward
# format: "interface_dstip_dstport"
port[f_tcp_adm]="{{ iptables_f_tcp_adm | default() }}"
# 
port[f_udp_adm]="{{ iptables_f_udp_adm | default() }}"

### Network san (system)
## Inbound
# 
port[i_tcp_san]="{{ iptables_i_tcp_san | default() }}"
# 
port[i_udp_san]="{{ iptables_i_udp_san | default() }}"
## Outbound
# 
port[o_tcp_san]="{{ iptables_o_tcp_san | default() }}"
# 
port[o_udp_san]="{{ iptables_o_udp_san | default() }}"
## Forward
# format: "interface_dstip_dstport"
port[f_tcp_san]="{{ iptables_f_tcp_san | default() }}"
# 
port[f_udp_san]="{{ iptables_f_udp_san | default() }}"

### Network srv (server)
## Inbound
# ssh identd
port[i_tcp_srv]="{{ iptables_i_tcp_srv | default('22 113') }}"
# ntp
port[i_udp_srv]="{{ iptables_i_udp_srv | default('123') }}"
## Outbound
# kdc kadmin kpasswd ldap ldaps dphys-config netdata
port[o_tcp_srv]="{{ iptables_o_tcp_srv | default('88 749 464 389 636 1984 19999') }}"
# ntp syslog kdc kadmin kpasswd ldap ldaps netdata
port[o_udp_srv]="{{ iptables_o_udp_srv | default('123 514 88 749 464 389 636 19999') }}"
## Forward
# format: "interface_dstip_dstport"
port[f_tcp_srv]="{{ iptables_f_tcp_srv | default() }}"
# 
port[f_udp_srv]="{{ iptables_f_udp_srv | default() }}"

### Network lan (department)
## Inbound
# ssh
port[i_tcp_lan]="{{ iptables_i_tcp_lan | default() }}"
# 
port[i_udp_lan]="{{ iptables_i_udp_lan | default() }}"
## Outbound
# ssh
port[o_tcp_lan]="{{ iptables_o_tcp_lan | default() }}"
# 
port[o_udp_lan]="{{ iptables_o_udp_lan | default() }}"
## Forward
# format: "interface_dstip_dstport"
port[f_tcp_lan]="{{ iptables_f_tcp_lan | default() }}"
# 
port[f_udp_lan]="{{ iptables_f_udp_lan | default() }}"

### Network can (campus)
## Inbound
# 
port[i_tcp_can]="{{ iptables_i_tcp_can | default() }}"
# 
port[i_udp_can]="{{ iptables_i_udp_can | default() }}"
## Outbound
# dhcp
port[o_tcp_can]="{{ iptables_o_tcp_can | default('67') }}"
# dhcp
port[o_udp_can]="{{ iptables_o_udp_can | default('67') }}"
## Forward
# format: "interface_dstip_dstport"
port[f_tcp_can]="{{ iptables_f_tcp_can | default() }}"
# 
port[f_udp_can]="{{ iptables_f_udp_can | default() }}"

### Network cun (custom)
## Inbound
# ssh
port[i_tcp_cun]="{{ iptables_i_tcp_cun | default() }}"
# 
port[i_udp_cun]="{{ iptables_i_udp_cun | default() }}"
## Outbound
# ssh
port[o_tcp_cun]="{{ iptables_o_tcp_cun | default() }}"
# 
port[o_udp_cun]="{{ iptables_o_udp_cun | default() }}"
## Forward
# format: "interface_dstip_dstport"
port[f_tcp_cun]="{{ iptables_f_tcp_cun | default() }}"
# 
port[f_udp_cun]="{{ iptables_f_udp_cun | default() }}"

### Network any (internet)
## Inbound
# ssh
port[i_tcp_any]="{{ iptables_i_tcp_any | default() }}"
# 
port[i_udp_any]="{{ iptables_i_udp_any | default() }}"
## Outbound
# ssh smtp whois dns rwhois http https git gpg
port[o_tcp_any]="{{ iptables_o_tcp_any | default('22 25 43 53 4321 80 443 9418 11371') }}"
# whois dns ntp
port[o_udp_any]="{{ iptables_o_udp_any | default('43 53 123') }}"
## Forward
# format: "interface_dstip_dstport"
port[f_tcp_any]="{{ iptables_f_tcp_any | default() }}"
# 
port[f_udp_any]="{{ iptables_f_udp_any | default() }}"

#### Port forwards
# format: "interface_port_dstip_dstport"
nat[4_f_tcp]="{{ iptables_nat4_f_tcp | default() }}"
# 
nat[4_f_udp]="{{ iptables_nat4_f_udp | default() }}"
