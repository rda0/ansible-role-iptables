---
- name: install required pkgs for iptables
  apt: 
    name: '{{ item }}'
    update_cache: yes
    cache_valid_time: 3600
  with_items:
    - ipset
    - iprange
#    - xtables-addons-common

- name: create directory /etc/iptables
  file: path=/etc/iptables state=directory

- name: create iptables config
  include_tasks: partials/deploy-template.yml
  with_items:
    - src: iptables.conf
      dest: /etc/iptables/iptables.conf
      notify: restore iptables
    - src: conf.nat.policy
      dest: /etc/iptables/conf.nat.policy
      notify: restore iptables
    - src: conf.nat.rules
      dest: /etc/iptables/conf.nat.rules
      notify: restore iptables
    - src: conf.filter.policy
      dest: /etc/iptables/conf.filter.policy
      notify: restore iptables
    - src: conf.filter.rules.head.conntrack.sh
      dest: /etc/iptables/conf.filter.rules.head.conntrack.sh
      mode: '0755'
      notify: restore iptables
    - src: conf.filter.rules.head.ipv4.lo.sh
      dest: /etc/iptables/conf.filter.rules.head.ipv4.lo.sh
      mode: '0755'
      notify: restore iptables
    - src: conf.filter.rules.head.ipv6.lo.sh
      dest: /etc/iptables/conf.filter.rules.head.ipv6.lo.sh
      mode: '0755'
      notify: restore iptables
    - src: conf.filter.rules.head.lo
      dest: /etc/iptables/conf.filter.rules.head.lo
      notify: restore iptables
    - src: conf.filter.rules.head.ipv4.icmp.sh
      dest: /etc/iptables/conf.filter.rules.head.ipv4.icmp.sh
      mode: '0755'
      notify: restore iptables
    - src: conf.filter.rules.head.ipv6.icmp.sh
      dest: /etc/iptables/conf.filter.rules.head.ipv6.icmp.sh
      mode: '0755'
      notify: restore iptables
    - src: conf.filter.rules.head.ratelimit.sh
      dest: /etc/iptables/conf.filter.rules.head.ratelimit.sh
      mode: '0755'
      notify: restore iptables
    - src: conf.filter.rules.body.sh
      dest: /etc/iptables/conf.filter.rules.body.sh
      mode: '0755'
      notify: restore iptables
    - src: conf.filter.rules.body.ipv4.sh
      dest: /etc/iptables/conf.filter.rules.body.ipv4.sh
      mode: '0755'
      notify: restore iptables
    - src: conf.filter.rules.body.ipv6.sh
      dest: /etc/iptables/conf.filter.rules.body.ipv6.sh
      mode: '0755'
      notify: restore iptables
    - src: conf.filter.rules.tail.sh
      dest: /etc/iptables/conf.filter.rules.tail.sh
      mode: '0755'
      notify: restore iptables
    - src: conf.filter.rules.tail.ipv4.sh
      dest: /etc/iptables/conf.filter.rules.tail.ipv4.sh
      mode: '0755'
      notify: restore iptables
    - src: conf.filter.rules.tail.ipv6.sh
      dest: /etc/iptables/conf.filter.rules.tail.ipv6.sh
      mode: '0755'
      notify: restore iptables
    - src: conf.filter.rules.head.ipv4.private.sh
      dest: /etc/iptables/conf.filter.rules.head.ipv4.private.sh
      mode: '0755'
      notify: restore iptables
    - src: conf.filter.rules.head.ipv6.private.sh
      dest: /etc/iptables/conf.filter.rules.head.ipv6.private.sh
      mode: '0755'
      notify: restore iptables
    - src: iptables.sh
      dest: /etc/iptables/iptables.sh
      mode: '0755'
      notify: restore iptables
    - src: iptables-flush-allow.sh
      dest: /etc/iptables/iptables-flush-allow.sh
      mode: '0755'
    - src: ipset-flush.sh
      dest: /etc/iptables/ipset-flush.sh
      mode: '0755'
    - src: iptables-start.sh
      dest: /etc/iptables/iptables-start.sh
      mode: '0755'
    - src: iptables-stop.sh
      dest: /etc/iptables/iptables-stop.sh
      mode: '0755'
    - src: iptables.service
      dest: /etc/systemd/system/iptables.service
      owner: root
      group: root
      mode: '0644'
  loop_control:
    loop_var: file
  when: use_iptables|default(true)

- name: create link /etc/network/if-pre-up.d/iptables
  file:
    src: /etc/iptables/iptables.sh
    dest: /etc/network/if-pre-up.d/iptables
    owner: root
    group: root
    state: link
  when: use_iptables|default(true) and not use_iptables_systemd|default(false)

- name: create iptables syslog config
  include_tasks: partials/deploy-template.yml
  with_items:
    - src: rsyslog.conf
      dest: /etc/rsyslog.d/iptables.conf
      notify: restart rsyslog
    - src: logrotate.conf
      dest: /etc/logrotate.d/iptables.conf
  loop_control:
    loop_var: file
  when: use_iptables|default(true)

- name: enable iptables.service
  systemd:
    enabled: yes
    daemon_reload: yes
    name: iptables
  when: use_iptables|default(true) and use_iptables_systemd|default(false)

#- name: custom network
#  lineinfile:
#    dest: /etc/iptables/iptables.conf
#    regexp: "^NET4_CUSTOM=\"{{ iptables_net4_custom }}\""
#    line: "NET4_CUSTOM=\"{{ iptables_net4_custom }}\""
#  when: use_iptables|default(true) and iptables_net4_custom is defined
