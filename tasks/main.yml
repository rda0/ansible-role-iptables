---
- name: install required pkgs for iptables
  package:
    pkg:
    - iptables
    - ipset
    - iprange

- name: create directory /etc/iptables
  file:
    path: /etc/iptables
    state: directory

- name: create iptables config
  template:
    src: iptables.conf.j2
    dest: /etc/iptables/iptables.conf
    mode: '0644'
  notify: restart iptables

- name: create directory /etc/iptables/ipsets.d
  file:
    path: /etc/iptables/ipsets.d
    state: directory

- name: create ipsets generate scripts
  copy:
    src: 'ipsets.d/{{ item }}.sh'
    dest: '/etc/iptables/ipsets.d/{{ item }}'
    mode: '0644'
  notify: restart iptables
  loop:
    - 00-dynamic
    - 10-static

- name: create directory /etc/iptables/rules.d
  file: path=/etc/iptables/rules.d state=directory

- name: create iptables rules generate scripts
  copy:
    src: 'rules.d/{{ item }}.sh'
    dest: '/etc/iptables/rules.d/{{ item }}'
    mode: '0644'
  notify: restart iptables
  loop:
    - 00-raw-policy
    - 10-raw-rule
    - 20-nat-policy
    - 30-nat-rule
    - 40-mangle-policy
    - 50-mangle-rule
    - 60-filter-policy
    - 70-filter-rule-head-common
    - 71-filter-rule-head-accept
    - 72-filter-rule-head-invalid
    - 73-filter-rule-head-private
    - 74-filter-rule-head-icmp
    - 75-filter-rule-head-ratelimit
    - 76-filter-rule-body
    - 77-filter-rule-tail

- name: remove obsolete config
  file:
    path: '/etc/iptables/{{ item }}'
    state: absent
  loop:
    - conf.raw.rules
    - conf.nat.rules
    - conf.mangle.rules
    - conf.filter.rules.head.accept
    - conf.filter.rules.head.invalid
    - conf.filter.rules.head.private
    - conf.filter.rules.head.icmp
    - conf.filter.rules.head.ratelimit
    - conf.filter.rules.body
    - conf.filter.rules.body.ipv4
    - conf.filter.rules.body.ipv6
    - conf.filter.rules.tail
    - up.rules.ipv4
    - up.rules.ipv6
    - up.rules.ipv
    - conf.ipset
    - conf.raw.policy
    - conf.raw.rule
    - conf.nat.policy
    - conf.nat.rule
    - conf.mangle.policy
    - conf.mangle.rule
    - conf.filter.policy
    - conf.filter.rule
    - conf.filter.rule.head.accept
    - conf.filter.rule.head.invalid
    - conf.filter.rule.head.private
    - conf.filter.rule.head.icmp
    - conf.filter.rule.head.ratelimit
    - conf.filter.rule.body
    - conf.filter.rule.tail
    - up.rules
    - last.4.rules
    - last.6.rules
    - last.ipsets
    - new.ipsets
    - new.rules

- name: create iptables scripts
  copy:
    src: 'sbin/{{ item }}.sh'
    dest: '/usr/local/sbin/{{ item }}'
    mode: '0755'
  notify: restart iptables
  loop:
    - iptables-restart
    - iptables-start
    - iptables-stop
    - iptables-flush
    - ipsets-flush

- name: remove obsolete iptables scripts
  file:
    path: '/usr/sbin/{{ item }}'
    state: absent
  loop:
    - iptables-reload
    - iptables-start
    - iptables-stop
    - iptables-flush
    - ipset-flush

- name: create iptables systemd service file
  copy:
    src: service/iptables.service
    dest: /etc/systemd/system/iptables.service
    owner: root
    group: root
    mode: '0644'

- name: 'remove obsolete rsyslog conf: /etc/rsyslog.d/iptables.conf TODO: remove'
  file:
    path: /etc/rsyslog.d/iptables.conf
    state: absent

- name: create iptables rsyslog config
  copy:
    src: log/rsyslog.conf
    dest: /etc/rsyslog.d/00-iptables.conf
  notify: restart rsyslog

- name: create iptables logrotate config
  copy:
    src: log/logrotate.conf
    dest: /etc/logrotate.d/iptables.conf

- name: create directory /etc/systemd/system/libvirtd.service.d
  file:
    path: /etc/systemd/system/libvirtd.service.d
    state: directory

- name: create systemd libvirtd.service override
  copy:
    src: service/libvirtd.service.override.conf
    dest: /etc/systemd/system/libvirtd.service.d/override.conf
  register: systemd_libvirtd_service_override

- name: create directory /etc/systemd/system/fail2ban.service.d
  file:
    path: /etc/systemd/system/fail2ban.service.d
    state: directory

- name: create systemd fail2ban.service override
  copy:
    src: service/fail2ban.service.override.conf
    dest: /etc/systemd/system/fail2ban.service.d/override.conf
  register: systemd_fail2ban_service_override

- name: enable systemd iptables.service
  systemd:
    enabled: yes
    daemon_reload: yes
    name: iptables

- name: remove obsolete link /etc/network/if-pre-up.d/iptables
  file:
    path: /etc/network/if-pre-up.d/iptables
    state: absent
