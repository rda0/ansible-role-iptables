---
- name: install required pkgs for iptables
  apt: 
    name: '{{ item }}'
    update_cache: yes
    cache_valid_time: 3600
  with_items:
    - iptables
    - ipset
    - iprange
  when: use_iptables|default(true)

- name: create directory /etc/iptables
  file: path=/etc/iptables state=directory
  when: use_iptables|default(true)

- name: create iptables config
  template:
    src: '{{ item }}'
    dest: '/etc/iptables/{{ item }}'
    mode: '0644'
  notify: restart iptables
  with_items:
    - iptables.conf
    - conf.raw.policy
    - conf.raw.rules
    - conf.nat.policy
    - conf.nat.rules
    - conf.mangle.policy
    - conf.mangle.rules
    - conf.filter.policy
    - conf.filter.rules.head.lo
    - conf.filter.rules.head.conntrack
    - conf.filter.rules.head.ratelimit
    - conf.filter.rules.head.ipv4.icmp
    - conf.filter.rules.head.ipv4.lo
    - conf.filter.rules.head.ipv4.private
    - conf.filter.rules.head.ipv6.icmp
    - conf.filter.rules.head.ipv6.lo
    - conf.filter.rules.head.ipv6.private
    - conf.filter.rules.body
    - conf.filter.rules.body.ipv4
    - conf.filter.rules.body.ipv6
    - conf.filter.rules.tail
    - conf.filter.rules.tail.ipv4
    - conf.filter.rules.tail.ipv6
  when: use_iptables|default(true)

- name: create iptables scripts
  template:
    src: '{{ item }}'
    dest: '/usr/sbin/{{ item }}'
    mode: '0755'
  notify: restart iptables
  with_items:
    - iptables-reload
    - iptables-start
    - iptables-stop
    - iptables-flush
    - ipset-flush
  when: use_iptables|default(true)

- name: create iptables systemd service file
  template:
    src: iptables.service
    dest: /etc/systemd/system/iptables.service
    owner: root
    group: root
    mode: '0644'
  when: use_iptables|default(true)

- name: create iptables rsyslog config
  template:
    src: rsyslog.conf
    dest: /etc/rsyslog.d/iptables.conf
  notify: restart rsyslog
  when: use_iptables|default(true)

- name: create iptables logrotate config
  template:
    src: logrotate.conf
    dest: /etc/logrotate.d/iptables.conf
  when: use_iptables|default(true)

- name: enable via symlink in /etc/network/if-pre-up.d/iptables
  file:
    src: /usr/sbin/iptables-reload
    dest: /etc/network/if-pre-up.d/iptables
    owner: root
    group: root
    state: link
  when: use_iptables|default(true) and not use_iptables_systemd|default(true)

- name: enable systemd iptables.service
  systemd:
    enabled: yes
    daemon_reload: yes
    name: iptables
  when: use_iptables|default(true) and use_iptables_systemd|default(true)

- name: remove link /etc/network/if-pre-up.d/iptables
  file:
    dest: /etc/network/if-pre-up.d/iptables
    state: absent
  when: use_iptables|default(true) and use_iptables_systemd|default(true)

- name: disable systemd iptables.service
  systemd:
    enabled: no
    daemon_reload: yes
    name: iptables
  when: use_iptables|default(true) and not use_iptables_systemd|default(true)
